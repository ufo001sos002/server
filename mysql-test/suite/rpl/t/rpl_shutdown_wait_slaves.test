#
# MDEV-18450 "Slow" shutdown to wait for slaves that are to be fed
# with everything in the master binlog before shutdown completes.
#

--source include/have_debug.inc
--let $rpl_topology=1->2, 1->3, 1->4
--source include/rpl_init.inc

--connection server_1
CREATE TABLE t1 (a INT);

--save_master_pos

--connection server_2
--sync_with_master

--connection server_3
--sync_with_master

--connection server_4
--source include/stop_slave.inc

--connection server_1
--let $count=1000
while ($count)
{
 INSERT INTO t1 SET a=1;
 --dec $count
}
--save_master_pos

# Shutdown master and restart server_4 who will be waiting for the master
# to start replication at its shutdown beginning phase.
--connection server_1
SET @@GLOBAL.debug_dbug="+d,simulate_delay_at_shutdown";

--connection server_4
--source include/start_slave.inc

--connection server_1
--write_file $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
wait
EOF
--shutdown_server 60
--source include/wait_until_disconnected.inc
#
# MDEV-18450 liveness condition:
# Despite shutdown even "late" slave #4 is in sync
#
--connection server_4
--sync_with_master

--connection server_3
--sync_with_master

--connection server_2
--sync_with_master

--connection server_1
--append_file $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
restart
EOF

--connection default
--enable_reconnect
--source include/wait_until_connected_again.inc
--connection server_1
--enable_reconnect
--source include/wait_until_connected_again.inc

#
# Cleanup
#
--connection server_1
DROP TABLE t1;

--connection server_2
--source include/start_slave.inc
--connection server_3
--source include/start_slave.inc
--connection server_4
--source include/start_slave.inc

--source include/rpl_end.inc
